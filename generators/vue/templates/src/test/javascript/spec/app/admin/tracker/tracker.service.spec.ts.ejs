import { ref, Ref } from 'vue';
import { createLocalVue, shallowMount } from '@vue/test-utils';
import VueRouter from 'vue-router';
import { Subject } from 'rxjs';

import TrackerService, { useTrackerService } from '@/admin/tracker/tracker.service';

const localVue = createLocalVue();
localVue.use(VueRouter);

describe('Tracker Service', () => {
  let trackerService: TrackerService;
  let TrackerApp: any;
  let authenticated: Ref<boolean>;

  let mockStomp: any;
  let router: VueRouter;

  beforeEach(() => {
    router = new VueRouter();
    jest.spyOn(router, 'currentRoute', 'get').mockReturnValue({ fullPath: '/' } as any);
    router.afterEach = jest.fn();
    authenticated = ref(false);

    const watch$ = new Subject<any>();

    mockStomp = {
      publish: jest.fn(),
      watch: jest.fn().mockReturnValue(watch$),
      configure: jest.fn(),
      activate: jest.fn(),
      deactivate: jest.fn(),
      connectionState$: new Subject<any>(),
    };

    TrackerApp = {
      name: 'TrackerApp',
      template: `
        <div></div>
      `,
      setup() {
        trackerService = useTrackerService({ stomp: mockStomp });
        trackerService['buildUrl'] = () => '';
      },
    };
  });

  it('Should subscribe router activity', async () => {
    shallowMount(TrackerApp, { localVue, router, provide: { authenticated } });
    expect(router.afterEach).toBeCalledTimes(1);
  });

  it('Should call activate on authenticated', async () => {
    // WHEN
    authenticated.value = true;
    shallowMount(TrackerApp, { localVue, router, provide: { authenticated } });
    await localVue.nextTick();

    // THEN
    expect(mockStomp.activate).toBeCalledTimes(1);
  });

  it('Should send activity on connected', async () => {
    // GIVEN
    jest.spyOn(router, 'currentRoute', 'get').mockReturnValue({ fullPath: '/admin' } as any);
    shallowMount(TrackerApp, { localVue, router, provide: { authenticated } });

    // WHEN
    mockStomp.connectionState$.next(1);
    await localVue.nextTick();

    // THEN
    expect(mockStomp.publish).toBeCalledTimes(1);
    expect(mockStomp.publish).toBeCalledWith({ destination: '/topic/activity', body: JSON.stringify({ page: '/admin' }) });
  });

  it('Should disconnect on logout', async () => {
    // GIVEN
    authenticated.value = true;
    shallowMount(TrackerApp, { localVue, router, provide: { authenticated } });
    await localVue.nextTick();

    // WHEN
    authenticated.value = false;
    await localVue.nextTick();

    // THEN
    expect(mockStomp.deactivate).toBeCalledTimes(1);
  });
});
